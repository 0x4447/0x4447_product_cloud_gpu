{
    "EC2Instance": {
        "Type": "AWS::EC2::Instance",
        "Properties": {
            "InstanceType": "g3.4xlarge",
            "ImageId": { "Fn::FindInMap": [ "AWSAMIRegionMap", { "Ref": "AWS::Region" }, "WS2016FULLG3"] },
            "KeyName": { "Ref": "KeyPairName" },
            "IamInstanceProfile": { "Ref": "ECSInstanceProfile" },
            "BlockDeviceMappings": [
                {
                    "DeviceName": "/dev/sda1",
                    "Ebs": {
                        "VolumeSize": 100,
                        "VolumeType": "gp2"
                    }
                }
            ],
            "UserData": {
                "Fn::Base64": {
                    "Fn::Join": [
                        "",
                        [
                            "<script>",

                            "\n",

                            "Initialize-Disk -Number 1 -PartitionStyle 'MBR'",

                            "\n",

                            "cfn-init.exe -v -c config -s ",
                            { "Ref": "AWS::StackId" },
                            " -r EC2Instance",
                            " --region ",
                            { "Ref": "AWS::Region" },

                            "\n",

                            "cfn-signal.exe -e %ERRORLEVEL% --stack ",
                            { "Ref": "AWS::StackId" },
                            " --resource EC2Instance --region ",
                            { "Ref": "AWS::Region" },

                            "\n",

                            "</script>"
                        ]
                    ]
                }
            },
            "NetworkInterfaces": [ {
                "AssociatePublicIpAddress": "true",
                "DeviceIndex": "0",
                "GroupSet": [{ "Ref": "EC2SecurityGroup" }],
                "SubnetId": { "Ref": "VPCSubnetParam" }
            }],
            "Tags": [
                {
                    "Key": "Name",
                    "Value": "video-editing"
                },
                {
                    "Key": "Description",
                    "Value": "An instance to do Video Editing in the Cloud."
                }
            ]
        },
        "Metadata": {
            "AWS::CloudFormation::Init": {
                "configSets": {
                    "config": [
                        "setup",
                        "package_manager",
                        "packages"
                    ]
                },
                "setup": {
                    "services": {
                        "windows": {
                            "Audiosrv": {
                                "ensureRunning": "true",
                                "enabled": "true"
                            }
                        }
                    }
                },
                "package_manager": {
                    "files": {
                        "C:\\cfn\\scripts\\chocolatey.ps1": {
                            "source": {
                                "Fn::Sub": "https://chocolatey.org/install.ps1"
                            }
                        }
                    },
                    "commands": {
                        "01-install-chocolatey": {
                            "command": "powershell.exe -ExecutionPolicy Unrestricted C:\\cfn\\scripts\\chocolatey.ps1"
                        }
                    }
                },
                "packages": {
                    "commands": {
                        "01-install-chrome": {
                            "command": "C:\\ProgramData\\chocolatey\\bin\\choco.exe install --limit-output --no-progress -y googlechrome"
                        },
                        "02-install-awscli": {
                            "command": "C:\\ProgramData\\chocolatey\\bin\\choco.exe install --limit-output --no-progress -y awscli"
                        }
                    }
                }
            }
        }
    }
}
